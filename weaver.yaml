---
apiVersion: projectcontour.io/v1
kind: HTTPProxy
metadata:
  name: dreamkast-weaver
  labels:
    app: dreamkast-weaver
spec:
  virtualhost:
    fqdn: api.tmp.dev.cloudnativedays.jp
    tls:
      secretName: cert-manager/wildcard-dev-cloudnativedays-jp
  routes:
    - conditions:
      - prefix: /
      services:
      - name: dreamkast-weaver
        port: 8080
      cookieRewritePolicies:
      - name: _session_id
        secure: true
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dreamkast-weaver
  name: dreamkast-weaver
spec:
  ports:
  - port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app: dreamkast-weaver
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dreamkast-weaver
  labels:
    app: dreamkast-weaver
spec:
  replicas: 
  selector:
    matchLabels:
      app: dreamkast-weaver
  template:
    metadata:
      labels:
        app: dreamkast-weaver
    spec:
      initContainers:
      - name: initdb
        image: 607167088920.dkr.ecr.ap-northeast-1.amazonaws.com/dreamkast-weaver/initdb:latest
        imagePullPolicy: Always
        env:
        - name: DB_ENDPOINT
          value: dreamkast-dev-rds.c6eparu1hmbv.ap-northeast-1.rds.amazonaws.com
        - name: DB_PORT
          value: "3306"
        - name: DB_PASSWORD
          value: '`c$5YQv+Wmg4PV9K'
        - name: DB_USER
          value: admin
      containers:
      - name: dk-weaver
        image: 607167088920.dkr.ecr.ap-northeast-1.amazonaws.com/dreamkast-weaver/serve:latest
        imagePullPolicy: Always
        ports:
          - containerPort: 8080
        env:
        - name: DB_ENDPOINT
          value: dreamkast-dev-rds.c6eparu1hmbv.ap-northeast-1.rds.amazonaws.com
        - name: DB_PORT
          value: "3306"
        - name: DB_PASSWORD
          value: '`c$5YQv+Wmg4PV9K'
        - name: DB_USER
          value: admin
        livenessProbe:
          httpGet:
            port: 8080
            path: /
          failureThreshold: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            port: 8080
            path: /
          failureThreshold: 5
          periodSeconds: 10
        startupProbe:
          httpGet:
            port: 8080
            path: /
          failureThreshold: 30
          periodSeconds: 10

